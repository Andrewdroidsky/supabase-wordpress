# Session 2 - JWT Verification Crisis & Fix

**–î–∞—Ç–∞:** 2025-11-01
**–í—Ä–µ–º—è:** ~4 —á–∞—Å–∞
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–π –æ—Ç–ª–∞–¥–∫–∏)
**–¶–µ–ª—å:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å JWT verification (JWKS ‚Üí JWT Secret)

---

## üìã –ó–∞–¥–∞—á–∏ —Å–µ—Å—Å–∏–∏

- [x] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Magic Link –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- [x] –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å JWT verification failed (401)
- [x] –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å JWKS endpoint (–ø–æ—á–µ–º—É –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
- [x] –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —Å RS256 (JWKS) –Ω–∞ HS256 (JWT Secret)
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å CSP headers –¥–ª—è Web Workers
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å WordPress —Ñ–∏–ª—å—Ç—Ä—ã –ª–æ–º–∞—é—â–∏–µ JavaScript
- [x] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å fix —Å —Ä–µ–∞–ª—å–Ω—ã–º Magic Link

---

## üöÄ –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è

### 00:00 - –ù–∞—á–∞–ª–æ: –¢–µ—Å—Ç Magic Link (FAILED)

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Session 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, –Ω–æ –ª–æ–≥–∏–Ω –µ—â–µ –Ω–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª—Å—è

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –û—Ç–∫—Ä—ã–ª: http://localhost:8000/login/
2. –í–≤–µ–ª email: test@example.com
3. –ù–∞–∂–∞–ª: "Continue with email"

**–û–∂–∏–¥–∞–ª–æ—Å—å:**
- –°–æ–æ–±—â–µ–Ω–∏–µ "Check your email"
- Email –æ—Ç Supabase
- Magic Link –≤ email

**–ü–æ–ª—É—á–∏–ª:**
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ "Check your email"
- ‚úÖ Email –æ—Ç Supabase –ø—Ä–∏—à–µ–ª (~10 —Å–µ–∫—É–Ω–¥)
- ‚úÖ Magic Link –≤ email

4. **–ö–ª–∏–∫–Ω—É–ª Magic Link:**
   ```
   https://xxxxxxxxx.supabase.co/auth/v1/verify?token=xxx&type=magiclink&redirect_to=http://localhost:8000/login/
   ```

5. **Redirect –Ω–∞ WordPress:**
   ```
   http://localhost:8000/login/#access_token=eyJhbGci...&refresh_token=eyJhbGci...&type=magiclink
   ```

6. **Browser Console (F12):**
   ```
   POST http://localhost:8000/wp-json/supabase-auth/callback 401 (Unauthorized)

   Response:
   {
     "code": "rest_forbidden",
     "message": "JWT verification failed",
     "data": {"status": 401}
   }
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚ùå Magic Link –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç (401 Unauthorized)

**–í—Ä–µ–º—è:** ~10 –º–∏–Ω—É—Ç

---

### 00:10 - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: Docker Logs

**–ö–æ–º–∞–Ω–¥–∞:**
```bash
docker compose logs wordpress --tail=100
```

**–í—ã–≤–æ–¥:**
```
supabase_wp | [01-Nov-2025 10:15:23 UTC] PHP Fatal error:  Uncaught Exception:
supabase_wp | JWK Set did not contain any keys
supabase_wp | in /var/www/html/wp-content/plugins/supabase-bridge/supabase-bridge.php:234
supabase_wp | Stack trace:
supabase_wp | #0 JWT::decode() called at [supabase-bridge.php:234]
supabase_wp | #1 sb_verify_jwt() called at [supabase-bridge.php:180]
supabase_wp | #2 sb_handle_auth_callback() called at [WordPress REST API]
```

**Root Cause:** JWKS endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `{"keys": []}`

**–í—Ä–µ–º—è:** ~5 –º–∏–Ω—É—Ç

---

### 00:15 - –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: JWKS Endpoint

**–ü—Ä–æ–≤–µ—Ä–∫–∞ JWKS –≤—Ä—É—á–Ω—É—é:**

```bash
curl https://xxxxxxxxx.supabase.co/auth/v1/.well-known/jwks.json
```

**–û–∂–∏–¥–∞–ª–æ—Å—å:**
```json
{
  "keys": [
    {
      "kty": "RSA",
      "kid": "abc123",
      "use": "sig",
      "n": "...",
      "e": "AQAB"
    }
  ]
}
```

**–ü–æ–ª—É—á–∏–ª:**
```json
{
  "keys": []
}
```

**‚ö†Ô∏è –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤! –ü–æ—á–µ–º—É?**

**–ì–∏–ø–æ—Ç–µ–∑—ã:**

1. ‚ùå Supabase –ø—Ä–æ–µ–∫—Ç –Ω–µ –≥–æ—Ç–æ–≤ (–Ω–æ –ø—Ä–æ—à–ª–æ —É–∂–µ 24 —á–∞—Å–∞ —Å —Å–æ–∑–¥–∞–Ω–∏—è)
2. ‚ùå JWKS endpoint disabled (–Ω–æ endpoint —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –æ—Ç–≤–µ—á–∞–µ—Ç)
3. ‚úÖ **Supabase Cloud –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JWKS (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è JWT Secret)!**

**–í—Ä–µ–º—è:** ~15 –º–∏–Ω—É—Ç

---

### 00:30 - –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: Supabase Docs

**–û—Ç–∫—Ä—ã–ª:** https://supabase.com/docs/guides/auth/auth-helpers/nextjs

**–ù–∞—à–µ–ª —Å–µ–∫—Ü–∏—é:** JWT Verification

**–ö–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**

> Supabase uses **HS256 (HMAC with SHA-256)** for JWT signing.
> Use the **JWT Secret** from your project settings to verify tokens.

**–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:**

- **HS256** = symmetric encryption (–æ–¥–∏–Ω —Å–µ–∫—Ä–µ—Ç –¥–ª—è sign –∏ verify)
- **RS256** = asymmetric encryption (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è sign, –ø—É–±–ª–∏—á–Ω—ã–π –¥–ª—è verify)
- **Supabase Cloud** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HS256, –Ω–µ RS256!
- **JWKS** –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è RS256 (–ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏)

**–í—ã–≤–æ–¥:** –ü–ª–∞–≥–∏–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –º–µ—Ç–æ–¥ verification!

**–í—Ä–µ–º—è:** ~20 –º–∏–Ω—É—Ç

---

### 00:50 - –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –ø–ª–∞–≥–∏–Ω–∞

**–û—Ç–∫—Ä—ã–ª:** supabase-bridge.php

**–ù–∞—à–µ–ª —Ñ—É–Ω–∫—Ü–∏—é:**
```php
function sb_verify_jwt($jwt) {
    // Fetch JWKS
    $jwks_url = sb_cfg('URL') . '/auth/v1/.well-known/jwks.json';
    $jwks = sb_fetch_jwks($jwks_url);  // Returns {"keys": []}

    // Parse keys
    $keys = JWK::parseKeySet($jwks);  // ‚Üê FAILS HERE! Empty array!

    // Decode JWT
    $decoded = JWT::decode($jwt, $keys);  // Never reached

    return $decoded;
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `parseKeySet()` –æ–∂–∏–¥–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å –∫–ª—é—á–∞–º–∏
- –ü–æ–ª—É—á–∞–µ—Ç `{"keys": []}` (–ø—É—Å—Ç–æ–π)
- –ë—Ä–æ—Å–∞–µ—Ç Exception: "JWK Set did not contain any keys"

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è HS256:**
```php
function sb_verify_jwt($jwt) {
    // Use JWT Secret (HS256)
    $jwt_secret = sb_cfg('JWT_SECRET');  // From WordPress settings

    // Decode with secret
    $decoded = JWT::decode($jwt, new Key($jwt_secret, 'HS256'));

    return $decoded;
}
```

**–í—Ä–µ–º—è:** ~15 –º–∏–Ω—É—Ç

---

### 01:05 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ JWT Secret

**–ò–∑–º–µ–Ω–∏–ª supabase-bridge.php:**

```php
// BEFORE (BROKEN):
function sb_verify_jwt($jwt) {
    $jwks_url = sb_cfg('URL') . '/auth/v1/.well-known/jwks.json';
    $jwks = sb_fetch_jwks($jwks_url);
    $keys = JWK::parseKeySet($jwks);
    $decoded = JWT::decode($jwt, $keys);
    return $decoded;
}

// AFTER (FIXED):
function sb_verify_jwt($jwt) {
    // Get JWT Secret from settings
    $jwt_secret = sb_cfg('JWT_SECRET');

    if (empty($jwt_secret)) {
        throw new Exception('JWT Secret not configured');
    }

    // Decode JWT with HS256
    try {
        $decoded = JWT::decode($jwt, new Key($jwt_secret, 'HS256'));
        return (array)$decoded;
    } catch (Exception $e) {
        error_log('Supabase Bridge: JWT verification failed: ' . $e->getMessage());
        throw $e;
    }
}
```

**–¢–∞–∫–∂–µ —É–¥–∞–ª–∏–ª:**
- –§—É–Ω–∫—Ü–∏—é `sb_fetch_jwks()` (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞)
- Transient –∫—ç—à –¥–ª—è JWKS (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω)

**–í—Ä–µ–º—è:** ~20 –º–∏–Ω—É—Ç

---

### 01:25 - –¢–µ—Å—Ç –ø–æ—Å–ª–µ fix (STILL FAILED)

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª WordPress:
   ```bash
   docker compose restart wordpress
   ```

2. –û—Ç–∫—Ä—ã–ª: http://localhost:8000/login/
3. –í–≤–µ–ª email: test-new@example.com
4. –ö–ª–∏–∫–Ω—É–ª Magic Link

**–ü–æ–ª—É—á–∏–ª:**
```
POST http://localhost:8000/wp-json/supabase-auth/callback 401 (Unauthorized)

Response:
{
  "code": "rest_forbidden",
  "message": "Refused to create a worker from 'blob:...'",
  "data": {"status": 401}
}
```

**‚ö†Ô∏è –ù–æ–≤–∞—è –æ—à–∏–±–∫–∞! CSP –±–ª–æ–∫–∏—Ä—É–µ—Ç Web Workers!**

**–í—Ä–µ–º—è:** ~10 –º–∏–Ω—É—Ç

---

### 01:35 - –ù–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞: CSP Headers

**Browser Console –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
```
Refused to create a worker from 'blob:http://localhost:8000/...'
because it violates the following Content Security Policy directive:
"worker-src 'self'"
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- Supabase JS SDK –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Web Workers –¥–ª—è crypto –æ–ø–µ—Ä–∞—Ü–∏–π
- WordPress –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–æ–∫–∏—Ä—É–µ—Ç `blob:` sources –≤ CSP
- CSP header: `worker-src 'self'` (–Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç `blob:`)

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å CSP headers –≤ –ø–ª–∞–≥–∏–Ω:

```php
// Add CSP headers to allow Supabase JS SDK Web Workers
function sb_add_csp_headers() {
    // Only on pages with auth form
    if (!is_page() && !is_single()) {
        return;
    }

    header("Content-Security-Policy: script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net blob:; worker-src 'self' blob:;");
}
add_action('send_headers', 'sb_add_csp_headers');
```

**–î–æ–±–∞–≤–∏–ª –≤ supabase-bridge.php**

**–í—Ä–µ–º—è:** ~15 –º–∏–Ω—É—Ç

---

### 01:50 - –¢–µ—Å—Ç –ø–æ—Å–ª–µ CSP fix (STILL FAILED)

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª WordPress
2. Hard reload —Å—Ç—Ä–∞–Ω–∏—Ü—ã (Ctrl+Shift+R)
3. –û—Ç–∫—Ä—ã–ª: http://localhost:8000/login/
4. –í–≤–µ–ª email: test-csp@example.com
5. –ö–ª–∏–∫–Ω—É–ª Magic Link

**Browser Console:**
```
Uncaught SyntaxError: Invalid or unexpected token
at auth-form.html:1052

Code:
if (session &#038;&#038; session.user) {
              ^
```

**‚ö†Ô∏è –ï—â–µ –æ–¥–Ω–∞ –æ—à–∏–±–∫–∞! WordPress —Ñ–∏–ª—å—Ç—Ä—ã –ª–æ–º–∞—é—Ç JavaScript!**

**–í—Ä–µ–º—è:** ~10 –º–∏–Ω—É—Ç

---

### 02:00 - –ù–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞: WordPress Filters

**View Page Source (Ctrl+U):**
```html
<script>
// JavaScript –≤—Å—Ç—Ä–æ–µ–Ω –≤ HTML
if (session && session.user) {  // ‚Üê –î–æ–ª–∂–Ω–æ –±—ã—Ç—å
if (session &#038;&#038; session.user) {  // ‚Üê –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å!
</script>
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- WordPress –ø—Ä–∏–º–µ–Ω—è–µ—Ç `wptexturize` —Ñ–∏–ª—å—Ç—Ä –∫ –í–°–ï–ú–£ –∫–æ–Ω—Ç–µ–Ω—Ç—É
- –§–∏–ª—å—Ç—Ä –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç `&&` –≤ HTML entity `&#038;&#038;`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JavaScript!

**Root Cause:**
JavaScript –±—ã–ª –≤—Å—Ç—Ä–æ–µ–Ω –≤ HTML —á–µ—Ä–µ–∑ `the_content` filter:

```php
// BEFORE (BROKEN):
function sb_auth_form_shortcode() {
    ob_start();
    ?>
    <div id="auth-form">...</div>
    <script>
    // JavaScript –∫–æ–¥ –ø—Ä—è–º–æ –≤ HTML!
    const supabase = createClient(...);
    if (session && session.user) { ... }  // ‚Üê WordPress –∏—Å–ø–æ—Ä—Ç–∏—Ç —ç—Ç–æ!
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('supabase_auth_form', 'sb_auth_form_shortcode');
```

**–†–µ—à–µ–Ω–∏–µ:**
–í—ã–Ω–µ—Å—Ç–∏ JavaScript –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª:

```php
// AFTER (FIXED):
function sb_auth_form_shortcode() {
    // Enqueue external JavaScript file
    wp_enqueue_script(
        'supabase-auth-form',
        plugins_url('auth-form.js', __FILE__),
        ['supabase-js'],
        filemtime(plugin_dir_path(__FILE__) . 'auth-form.js'),  // Cache busting
        true
    );

    // Pass config to JavaScript
    wp_localize_script('supabase-auth-form', 'supabaseConfig', [
        'url' => sb_cfg('URL'),
        'anonKey' => sb_cfg('ANON_KEY'),
        'redirectUrl' => home_url('/login/'),
    ]);

    // Return only HTML (no JavaScript!)
    return '<div id="auth-form">...</div>';
}
```

**–°–æ–∑–¥–∞–ª:** auth-form.js (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª)

**–í—Ä–µ–º—è:** ~30 –º–∏–Ω—É—Ç

---

### 02:30 - –¢–µ—Å—Ç –ø–æ—Å–ª–µ JavaScript fix (SUCCESS!)

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª WordPress
2. Hard reload (Ctrl+Shift+R)
3. –ü—Ä–æ–≤–µ—Ä–∏–ª View Source:
   ```html
   <script src="/wp-content/plugins/supabase-bridge/auth-form.js?ver=1699012345"></script>
   ```
   ‚úÖ JavaScript –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ!

4. –û—Ç–∫—Ä—ã–ª: http://localhost:8000/login/
5. –í–≤–µ–ª email: test-final@example.com
6. –ù–∞–∂–∞–ª: Continue with email
7. –ö–ª–∏–∫–Ω—É–ª Magic Link –≤ email

**Browser Console:**
```
Supabase Auth initialized
Token received: eyJhbGci...
Sending token to WordPress...
POST http://localhost:8000/wp-json/supabase-auth/callback 200 (OK)

Response:
{
  "redirect_url": "/"
}
```

**‚úÖ Redirect –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É!**

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ WordPress admin bar –ø–æ—è–≤–∏–ª—Å—è —Å–≤–µ—Ä—Ö—É
- ‚úÖ –ù–∞–¥–ø–∏—Å—å: "Howdy, test-final@example.com"
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω!

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Magic Link –†–ê–ë–û–¢–ê–ï–¢!

**–í—Ä–µ–º—è:** ~10 –º–∏–Ω—É—Ç

---

### 02:40 - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**WordPress MySQL:**
```bash
docker compose exec db mysql -uwordpress -pwordpress_password wordpress
```

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT ID, user_email, user_login FROM wp_users;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
ID  | user_email              | user_login
----|-------------------------|------------------
1   | koper@example.com       | admin
2   | test-final@example.com  | test_final_5f3a2
```

‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Supabase meta
SELECT user_id, meta_key, meta_value
FROM wp_usermeta
WHERE meta_key = 'supabase_user_id'
AND user_id = 2;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
user_id | meta_key          | meta_value
--------|-------------------|---------------------------------
2       | supabase_user_id  | 3f8a2c5d-... (UUID –æ—Ç Supabase)
```

‚úÖ –°–≤—è–∑—å WordPress ‚Üî Supabase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!

**Supabase Dashboard:**
- Authentication ‚Üí Users ‚Üí –≤–∏–¥–∏–º test-final@example.com ‚úÖ
- Table Editor ‚Üí wp_user_registrations ‚Üí **–ü–£–°–¢–û** ‚ö†Ô∏è

**‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞:** –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∞ (–±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Session 3)

**–í—Ä–µ–º—è:** ~15 –º–∏–Ω—É—Ç

---

### 02:55 - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ edge cases

**Test Case 1: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

1. Logout –∏–∑ WordPress
2. –û—Ç–∫—Ä—ã–ª: /login/
3. –í–≤–µ–ª —Ç–æ—Ç –∂–µ email: test-final@example.com
4. –ö–ª–∏–∫–Ω—É–ª Magic Link

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –õ–æ–≥–∏–Ω —É—Å–ø–µ—à–Ω—ã–π
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è (–∏—â–µ—Ç—Å—è –ø–æ `supabase_user_id`)
- ‚úÖ Redirect –Ω–∞ –≥–ª–∞–≤–Ω—É—é

**Test Case 2: Email Confirmation –≤–∫–ª—é—á–µ–Ω (FAILED)**

**–ü—Ä–æ–≤–µ—Ä–∏–ª Supabase Settings:**
- Authentication ‚Üí Providers ‚Üí Email
- **Confirm email:** ON (toggle –≤–∫–ª—é—á–µ–Ω)

**–ü–æ–ø—ã—Ç–∫–∞ –ª–æ–≥–∏–Ω–∞:**
1. –ù–æ–≤—ã–π email: test-confirm@example.com
2. –ö–ª–∏–∫–Ω—É–ª Magic Link
3. **Redirect –Ω–∞:** `/auth/v1/verify?type=signup&token=...`
4. –ö–ª–∏–∫–Ω—É–ª —Å—Å—ã–ª–∫—É
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Email confirmed, –Ω–æ –ù–ï –∑–∞–ª–æ–≥–∏–Ω–µ–Ω! ‚ùå

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ö–æ–≥–¥–∞ "Confirm email" –≤–∫–ª—é—á–µ–Ω, Supabase —Ç—Ä–µ–±—É–µ—Ç 2 —à–∞–≥–∞:
  1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
  2. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω
- Magic Link —Å–∞–º —è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º ‚Üí –¥–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–ª–∏—à–Ω–µ

**–†–µ—à–µ–Ω–∏–µ:**
–í—ã–∫–ª—é—á–∏—Ç—å Email Confirmation:
- Supabase Dashboard ‚Üí Authentication ‚Üí Settings ‚Üí Providers ‚Üí Email
- **Confirm email:** OFF (toggle –≤—ã–∫–ª—é—á–∏—Ç—å)
- Save

**Test Case 3: –ü–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è Email Confirmation**

1. –ù–æ–≤—ã–π email: test-no-confirm@example.com
2. –ö–ª–∏–∫–Ω—É–ª Magic Link
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ó–∞–ª–æ–≥–∏–Ω–µ–Ω —Å—Ä–∞–∑—É, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤!

**–í—Ä–µ–º—è:** ~30 –º–∏–Ω—É—Ç

---

### 03:25 - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

**–°–æ–∑–¥–∞–ª –∑–∞–º–µ—Ç–∫–∏ –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö:**

1. **JWT Verification:**
   - –ü—Ä–æ–±–ª–µ–º–∞: JWKS –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
   - –ü—Ä–∏—á–∏–Ω–∞: Supabase Cloud –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HS256, –Ω–µ RS256
   - –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JWT Secret –≤–º–µ—Å—Ç–æ JWKS
   - –í—Ä–µ–º—è –æ—Ç–ª–∞–¥–∫–∏: ~75 –º–∏–Ω—É—Ç

2. **CSP Headers:**
   - –ü—Ä–æ–±–ª–µ–º–∞: Web Workers –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è CSP
   - –ü—Ä–∏—á–∏–Ω–∞: Default CSP –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç `blob:` sources
   - –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å `blob:` –≤ `script-src` –∏ `worker-src`
   - –í—Ä–µ–º—è –æ—Ç–ª–∞–¥–∫–∏: ~25 –º–∏–Ω—É—Ç

3. **WordPress Filters:**
   - –ü—Ä–æ–±–ª–µ–º–∞: JavaScript –∫–æ–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º
   - –ü—Ä–∏—á–∏–Ω–∞: `wptexturize` –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç `&&` –≤ `&#038;&#038;`
   - –†–µ—à–µ–Ω–∏–µ: –í—ã–Ω–µ—Å—Ç–∏ JavaScript –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª —á–µ—Ä–µ–∑ `wp_enqueue_script`
   - –í—Ä–µ–º—è –æ—Ç–ª–∞–¥–∫–∏: ~40 –º–∏–Ω—É—Ç

4. **Email Confirmation:**
   - –ü—Ä–æ–±–ª–µ–º–∞: Magic Link –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
   - –ü—Ä–∏—á–∏–Ω–∞: –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (Magic Link + Email Confirmation)
   - –†–µ—à–µ–Ω–∏–µ: –í—ã–∫–ª—é—á–∏—Ç—å Email Confirmation –≤ Supabase
   - –í—Ä–µ–º—è –æ—Ç–ª–∞–¥–∫–∏: ~30 –º–∏–Ω—É—Ç

**–í—Ä–µ–º—è:** ~15 –º–∏–Ω—É—Ç

---

### 03:40 - –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**Test Suite: Magic Link Flow**

1. **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
   - Email: final-test-1@example.com
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ó–∞–ª–æ–≥–∏–Ω–µ–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω

2. **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
   - Email: final-test-1@example.com (–ø–æ–≤—Ç–æ—Ä–Ω–æ)
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ó–∞–ª–æ–≥–∏–Ω–µ–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è

3. **Logout –∏ Login:**
   - Logout ‚Üí Login —Å —Ç–µ–º –∂–µ email
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ó–∞–ª–æ–≥–∏–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–∞—Ö:**
   - WordPress: ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å
   - Supabase Auth: ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å
   - wp_user_registrations: ‚ö†Ô∏è –ü—É—Å—Ç–æ (Session 3)

**Test Suite: Edge Cases**

5. **–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω:**
   - –ò–∑–º–µ–Ω–∏–ª access_token –≤ URL hash
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ 401 error, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∑–∞–ª–æ–≥–∏–Ω–µ–Ω

6. **–ò—Å—Ç–µ–∫—à–∏–π —Ç–æ–∫–µ–Ω:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—Ç–∞—Ä—ã–π Magic Link (> 1 —á–∞—Å)
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ Supabase –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Link expired"

7. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π JWT Secret:**
   - –ò–∑–º–µ–Ω–∏–ª JWT Secret –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ 401 error, –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "Signature verification failed"

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!

**–í—Ä–µ–º—è:** ~20 –º–∏–Ω—É—Ç

---

### 04:00 - –ò—Ç–æ–≥–∏ —Å–µ—Å—Å–∏–∏

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**

‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ JWT verification (JWKS ‚Üí JWT Secret)
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã CSP headers (–¥–æ–±–∞–≤–ª–µ–Ω–æ `blob:` –¥–ª—è Web Workers)
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã WordPress —Ñ–∏–ª—å—Ç—Ä—ã (JavaScript –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ)
‚úÖ –û—Ç–∫–ª—é—á–µ–Ω–æ Email Confirmation –≤ Supabase
‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π Magic Link flow
‚úÖ –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**

- supabase-bridge.php (~80 —Å—Ç—Ä–æ–∫)
  - JWT verification —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞
  - CSP headers –¥–æ–±–∞–≤–ª–µ–Ω—ã
  - Shortcode refactored (JavaScript –≤—ã–Ω–µ—Å–µ–Ω)

- auth-form.js (—Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª, ~200 —Å—Ç—Ä–æ–∫)
  - Supabase JS SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  - Auth state change listeners
  - Token sending to WordPress backend

**–ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:**

‚ö†Ô∏è Google OAuth (–µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
‚ö†Ô∏è Facebook OAuth (–µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
‚ö†Ô∏è –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ wp_user_registrations (Session 3)
‚ö†Ô∏è Thank You page redirects (Session 3)

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Google OAuth (Session 3)
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π (Session 3)
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Thank You page redirects (Session 3)
- Webhook —Å–∏—Å—Ç–µ–º–∞ (Session 3)

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–í—Ä–µ–º—è:** ~4 —á–∞—Å–∞
**–ü—Ä–æ–±–ª–µ–º –Ω–∞–π–¥–µ–Ω–æ:** 4
**–ü—Ä–æ–±–ª–µ–º —Ä–µ—à–µ–Ω–æ:** 4
**–ö–æ–º–∞–Ω–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:** ~50
**Docker –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤:** 5
**Browser hard reloads:** 10
**SQL –∑–∞–ø—Ä–æ—Å–æ–≤:** 15

**–¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:** ~40k (–æ—Ü–µ–Ω–∫–∞)

---

## üí° –ì–ª–∞–≤–Ω—ã–µ —É—Ä–æ–∫–∏

### 1. JWT Verification Methods

**–£—Ä–æ–∫:** Supabase Cloud –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HS256 (JWT Secret), –Ω–µ RS256 (JWKS).

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
- JWKS –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è RS256 (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ –∫–ª—é—á–∏)
- HS256 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–¥–∏–Ω —Å–µ–∫—Ä–µ—Ç –¥–ª—è sign –∏ verify
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API –ø–µ—Ä–µ–¥ implementation!

**–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –±—É–¥—É—â–µ–º:** ~75 –º–∏–Ω—É—Ç

### 2. WordPress Content Filters

**–£—Ä–æ–∫:** –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—Å—Ç—Ä–∞–∏–≤–∞–π JavaScript –≤ content —á–µ—Ä–µ–∑ shortcode.

**–ü–æ—á–µ–º—É:**
- WordPress –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –∫ –í–°–ï–ú–£ –∫–æ–Ω—Ç–µ–Ω—Ç—É (`wptexturize`, `wpautop`, etc.)
- –§–∏–ª—å—Ç—Ä—ã –ª–æ–º–∞—é—Ç JavaScript —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (`&&` ‚Üí `&#038;&#038;`)
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π `wp_enqueue_script()` –¥–ª—è JavaScript!

**–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –±—É–¥—É—â–µ–º:** ~40 –º–∏–Ω—É—Ç

### 3. CSP –¥–ª—è Modern Web APIs

**–£—Ä–æ–∫:** Supabase JS SDK (–∏ –¥—Ä—É–≥–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏) –∏—Å–ø–æ–ª—å–∑—É—é—Ç Web Workers.

**–ü–æ—á–µ–º—É:**
- Web Workers —Ç—Ä–µ–±—É—é—Ç `blob:` sources –≤ CSP
- Default WordPress CSP –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç `blob:`
- –ü—Ä–æ–≤–µ—Ä—è–π CSP headers –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ third-party –±–∏–±–ª–∏–æ—Ç–µ–∫!

**–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –±—É–¥—É—â–µ–º:** ~25 –º–∏–Ω—É—Ç

### 4. Email Confirmation Conflict

**–£—Ä–æ–∫:** Magic Link —Å–∞–º —è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º email.

**–ü–æ—á–µ–º—É:**
- –í–∫–ª—é—á–µ–Ω–Ω—ã–π "Email Confirmation" —Å–æ–∑–¥–∞–µ—Ç –¥–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω: (1) –∫–ª–∏–∫–Ω—É—Ç—å Magic Link, (2) –∫–ª–∏–∫–Ω—É—Ç—å Confirmation Link
- –î–ª—è Magic Link flow –í–°–ï–ì–î–ê –æ—Ç–∫–ª—é—á–∞–π Email Confirmation!

**–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –±—É–¥—É—â–µ–º:** ~30 –º–∏–Ω—É—Ç

---

## üîç Debugging Techniques –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ

1. **Docker Logs Analysis:**
   ```bash
   docker compose logs wordpress --tail=100
   docker compose logs wordpress --follow
   docker compose logs wordpress | grep "Supabase Bridge"
   ```

2. **Browser DevTools:**
   - Console (JavaScript errors)
   - Network Tab (API requests, status codes)
   - Application Tab (localStorage, cookies)

3. **View Page Source:**
   - Check if JavaScript correctly loaded
   - Check for WordPress filter corruption

4. **Database Inspection:**
   - WordPress MySQL (users, usermeta, options)
   - Supabase Postgres (auth.users, wp_user_registrations)

5. **API Testing:**
   ```bash
   curl https://PROJECT.supabase.co/auth/v1/.well-known/jwks.json
   curl -I http://localhost:8000/login/  # Check CSP headers
   ```

6. **Code Tracing:**
   - Added `error_log()` statements
   - Checked WordPress debug.log
   - Used PHP var_dump() for array inspection

---

**–°–ª–µ–¥—É—é—â–∞—è —Å–µ—Å—Å–∏—è:** [2025-11-02-session3.md](2025-11-02-session3.md) - Webhook System & Redirects
